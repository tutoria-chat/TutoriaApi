name: Deploy to Elastic Beanstalk (Production)

on:
  push:
    branches:
      - prod
    paths:
      - 'src/**'
      - '.github/workflows/deploy-prod.yml'
  workflow_dispatch: # Allow manual trigger

env:
  AWS_REGION: us-east-2
  EB_APPLICATION_NAME: tutoria-api-prod
  EB_ENVIRONMENT_NAME: tutoria-api-prod-env
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    name: Build and Deploy to AWS Elastic Beanstalk (Production)
    runs-on: ubuntu-latest

    # Production environment requires manual approval
    environment:
      name: production
      url: ${{ steps.get-url.outputs.url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore TutoriaApi.sln

    - name: Build solution
      run: dotnet build TutoriaApi.sln --configuration Release --no-restore

    - name: Run tests
      run: dotnet test TutoriaApi.sln --configuration Release --no-build --verbosity minimal

    # TODO: Replace with unified project when we split Management and Auth deployments
    # For now, we deploy Management API only (Auth endpoints would need to be added or deployed separately)
    - name: Publish Management API
      run: dotnet publish src/TutoriaApi.Web.Management/TutoriaApi.Web.Management.csproj --configuration Release --output ./publish --no-build

    - name: Create appsettings.Production.json with secrets
      run: |
        cat > ./publish/appsettings.Production.json << 'EOF'
        {
          "ConnectionStrings": {
            "DefaultConnection": "${{ secrets.PROD_DB_CONNECTION_STRING }}"
          },
          "Jwt": {
            "SecretKey": "${{ secrets.PROD_JWT_SECRET_KEY }}",
            "Issuer": "${{ secrets.PROD_JWT_ISSUER }}",
            "Audience": "${{ secrets.PROD_JWT_AUDIENCE }}"
          },
          "AzureStorage": {
            "ConnectionString": "${{ secrets.PROD_AZURE_STORAGE_CONNECTION_STRING }}",
            "ContainerName": "${{ secrets.PROD_AZURE_STORAGE_CONTAINER }}"
          },
          "OpenAI": {
            "ApiKey": "${{ secrets.PROD_OPENAI_API_KEY }}"
          },
          "AWS": {
            "Region": "${{ secrets.PROD_AWS_SES_REGION }}",
            "AccessKeyId": "${{ secrets.PROD_AWS_SES_ACCESS_KEY_ID }}",
            "SecretAccessKey": "${{ secrets.PROD_AWS_SES_SECRET_ACCESS_KEY }}"
          },
          "Email": {
            "FromAddress": "${{ secrets.PROD_EMAIL_FROM_ADDRESS }}",
            "FromName": "${{ secrets.PROD_EMAIL_FROM_NAME }}",
            "FrontendUrl": "${{ secrets.PROD_EMAIL_FRONTEND_URL }}",
            "LogoUrl": "${{ secrets.PROD_EMAIL_LOGO_URL }}",
            "Enabled": true
          }
        }
        EOF

    - name: Create deployment package
      run: |
        cd publish
        zip -r ../deployment-package.zip .
        cd ..

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Generate version label
      run: |
        VERSION_LABEL="v-$(date +%Y%m%d-%H%M%S)"
        echo "VERSION_LABEL=$VERSION_LABEL" >> $GITHUB_ENV
        echo "Generated version label: $VERSION_LABEL"

    - name: Upload to S3
      run: |
        S3_BUCKET="${{ secrets.PROD_EB_S3_BUCKET }}"
        S3_KEY="tutoria-api-prod-$(date +%Y%m%d-%H%M%S).zip"
        aws s3 cp deployment-package.zip s3://$S3_BUCKET/$S3_KEY
        echo "S3_KEY=$S3_KEY" >> $GITHUB_ENV

    - name: Create Elastic Beanstalk application version
      run: |
        aws elasticbeanstalk create-application-version \
          --application-name ${{ env.EB_APPLICATION_NAME }} \
          --version-label "${{ env.VERSION_LABEL }}" \
          --source-bundle S3Bucket="${{ secrets.PROD_EB_S3_BUCKET }}",S3Key="${{ env.S3_KEY }}" \
          --description "Production Deployment from GitHub Actions - Commit ${{ github.sha }}"

    - name: Deploy to Elastic Beanstalk
      run: |
        aws elasticbeanstalk update-environment \
          --application-name ${{ env.EB_APPLICATION_NAME }} \
          --environment-name ${{ env.EB_ENVIRONMENT_NAME }} \
          --version-label "${{ env.VERSION_LABEL }}"

    - name: Wait for deployment to complete
      run: |
        echo "Waiting for environment to become healthy..."
        aws elasticbeanstalk wait environment-updated \
          --application-name ${{ env.EB_APPLICATION_NAME }} \
          --environment-name ${{ env.EB_ENVIRONMENT_NAME }}

    - name: Get deployment URL
      id: get-url
      run: |
        CNAME=$(aws elasticbeanstalk describe-environments \
          --application-name ${{ env.EB_APPLICATION_NAME }} \
          --environment-names ${{ env.EB_ENVIRONMENT_NAME }} \
          --query "Environments[0].CNAME" \
          --output text)
        echo "url=https://$CNAME" >> $GITHUB_OUTPUT
        echo "üöÄ Production deployment successful!"
        echo "üìç API URL: https://$CNAME"
        echo "üè• Health Check: https://$CNAME/health"
        echo "üìö Swagger UI: https://$CNAME/swagger"

    - name: Cleanup old versions (keep last 20 for production)
      run: |
        aws elasticbeanstalk describe-application-versions \
          --application-name ${{ env.EB_APPLICATION_NAME }} \
          --query "ApplicationVersions | sort_by(@, &DateCreated) | [0:-20].VersionLabel" \
          --output text | xargs -n 1 -I {} \
          aws elasticbeanstalk delete-application-version \
            --application-name ${{ env.EB_APPLICATION_NAME }} \
            --version-label {} \
            --delete-source-bundle
